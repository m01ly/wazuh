import csv
from opensearchpy import OpenSearch
# 创建 OpenSearch 客户端
os = OpenSearch(
        "xx.xx.xx.xx",
        verify_certs=False,
        verify_hostname=False,
        http_auth=("username", "password"),
        scheme="https",
        port=9200,
    )
def es_search_body():
    body = {
          #"track_total_hits": True,
        "query": {
         "term": {
            "rule.groups": "vulnerability-detector"
                }
            }
        }
    return body

#  精准查询
# 执行查询
requestheaders = {'Content-Type': 'application/json'}
response = os.search(headers=requestheaders,
    index="wazuh-alerts-*",
    body=es_search_body(),
    size=10000, scroll='1m'
)
scroll_id = response['_scroll_id']
total_hits = response['hits']['total']['value']

# 获取列名称
# columns = list(response['hits']['hits'][0]['_source']['data'].keys())
columns= ["hostip","hostname","vunl_name","vunl_severity","vunl_type","package_condition","package_name","package_version","cve","rule_description","rule_group","vunl_desription","timestamp"]# 将数据写入CSV文件
csv_file = 'output.csv'

with open(csv_file, 'w', newline='') as file:
    writer = csv.writer(file)
    # 写入列名称
    writer.writerow(columns)
    # 循环获取所有滚动数据
    while len(response['hits']['hits']) > 0:
        for hit in response['hits']['hits']:
            source = hit['_source']
            # print("source:"+str(source))
            vunlslist = source['data']["vulnerability"]
            if 'ip' in source['agent'].keys():
                ip=source['agent']['ip']
            else:
                ip=source['agent']['id']
            row = [ip, source["agent"]["name"], vunlslist["title"], vunlslist["severity"],
                   vunlslist["type"], vunlslist["package"]["condition"], vunlslist["package"]["name"],
                   vunlslist["package"]["version"], vunlslist["cve"], source["rule"]["description"],
                   source["rule"]["groups"], vunlslist["rationale"], source["timestamp"]]
            writer.writerow(row)

        # 获取下一批数据
        response = os.scroll(scroll_id=scroll_id, scroll='1m')
        scroll_id = response['_scroll_id']

print(f"数据已成功保存到文件: {csv_file}")
